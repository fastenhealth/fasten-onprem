<div class="az-content az-content-app pd-b-0 overflow-scrollable">
  <div class="container">
    <div class="az-content-body">
      <div class="az-content-breadcrumb">
        <span class="cursor-pointer" [routerLink]="['/explore', sourceId]">{{sourceName}}</span>
        <span>Resource</span>
        <span>{{resource?.source_resource_type}}</span>
        <span>{{resource?.source_resource_id}}</span>
      </div>

      <ng-container *ngIf="!loading else isLoadingTemplate">
        <fhir-card *ngIf="displayModel else noDisplayModel" [displayModel]="displayModel" [showDetails]="false"></fhir-card>

        <ng-template #noDisplayModel>
          <p> An error occurred while parsing FHIR resource </p>
        </ng-template>

        <!-- Delegated resource section -->
        <ng-container *ngIf="isDelegatedResource && canEditResource; else notDelegatedResource">
          <div class="alert alert-warning mb-5" role="alert">
            Enable Debug mode:
            <input type="checkbox" [(ngModel)]="debugMode" />
            <p class="text-muted">You can edit this resource</p>
          </div>

          <div *ngIf="resource && debugMode">
            <textarea
              [(ngModel)]="editableJson"
              rows="20"
              class="form-control font-monospace"
              style="width: 100%; overflow: auto"
              (ngModelChange)="validateJson()"
            ></textarea>

            <div class="mt-3 d-flex align-items-center">
            <button class="btn btn-success btn-sm mr-2" (click)="saveEditedResource()" [disabled]="!isJsonValid">
              Save Changes
            </button>
             <div *ngIf="!isJsonValid" class="text-danger small">
              Invalid JSON â€” please fix syntax before saving.
            </div>
            </div>
          </div>
        </ng-container>

        <!-- Non-delegated or without EDIT privileges resource fallback -->
        <ng-template #notDelegatedResource>
          <div class="alert alert-warning mb-5" role="alert">
            Enable Debug mode:
            <input type="checkbox" [(ngModel)]="debugMode" />
          </div>

          <div *ngIf="resource && debugMode">
            <pre><code [highlight]="resource.resource_raw | json"></code></pre>
          </div>
        </ng-template>
      </ng-container>
      <ng-template #isLoadingTemplate>
        <div class="row">
          <div class="col-12">
            <app-loading-spinner [loadingTitle]="'Please wait, loading report...'"></app-loading-spinner>
          </div>
        </div>
      </ng-template>
    </div><!-- az-content-body -->
  </div>
</div>
